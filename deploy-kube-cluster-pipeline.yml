jobs:
  - name: lab-prep
    plan:
      - get: git-resource
        trigger: true
      - config:
          image_resource:
            name: ""
            source:
              repository: sconrod/python-aws-image
              tag: 2.1
            type: docker-image
          inputs:
            - name: git-resource
          platform: linux
          run:
            path: sh
            args:
              - -ce
              - |
                export AWS_PAGER=""
                export Name=$NAME
                echo $NAME
                aws configure set aws_access_key_id $AWS_KEY_ID
                aws configure set aws_secret_access_key $AWS_KEY
                aws configure set default.region $REGION
                aws sts get-caller-identity --query Account --output text
        task: check-aws
        params:
          AWS_KEY_ID: ((Access_key_ID.Access_key))
          AWS_KEY: ((Secret_access_key.Secret_access_key))
          REGION: ((aws.region))
          NAME: ((az.name))
          VAULT_ADDR: ((vault.addr))

  - name: deploy-aws-iam
    plan:
      - get: git-resource
      - config:
          image_resource:
            name: ""
            source:
              repository: sconrod/python-aws-image
              tag: 2.1
            type: docker-image
          inputs:
            - name: git-resource
          platform: linux
          run:
            path: /bin/sh
            args:
              - -cex
              - |
                cd git-resource
                export AWS_PAGER=""
                export NAME=$NAME
                echo $NAME
                aws configure set aws_access_key_id $AWS_KEY_ID
                aws configure set aws_secret_access_key $AWS_KEY
                aws configure set default.region $REGION
                aws sts get-caller-identity --query Account --output text
                export AWS_PAGER=""
                export SSH_TOKEN=$SSH_TOKEN
                chmod a+x deploy-iam-aws.sh
                ./deploy-iam-aws.sh
        task: deploy-aws-iam
        params:
          AWS_KEY_ID: ((Access_key_ID.Access_key))
          AWS_KEY: ((Secret_access_key.Secret_access_key))
          REGION: ((aws.region))
          NAME: ((az.name))
          VAULT_ADDR: ((vault.addr))
          SSH_TOKEN: ((ssh-token.token))





resource_types:
resources:
  - name: git-resource
    source:
      Username: ((Username))
      branch: ((git-branch))
      email: ((email))
      private_key: ((private_key))
      uri: ((git-uri))
    type: git